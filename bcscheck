#!/usr/bin/env bash
# Focused wrapper for 'bcs check' with default BCS analysis prompts
set -euo pipefail
shopt -s inherit_errexit shift_verbose extglob nullglob

declare -r VERSION=1.0.0
#shellcheck disable=SC2155
declare -r SCRIPT_PATH=$(realpath -- "${BASH_SOURCE[0]}")
declare -r SCRIPT_NAME=${SCRIPT_PATH##*/}

die() { (($# < 2)) || >&2 echo "âœ— ${*:2}"; exit "${1:-1}"; }

declare -- APPEND_PROMPT='
Do a comprehensive analysis of this Bash script:

  - Check its compliance with the Bash Coding Standard (BCS).
  - Highlight actual coding errors.
  - List any possible improvements.
'

declare -a OPTS=(
  --tier summary
  --strict
  --add-dir "$(realpath -- "$PWD")"
  --add-dir /tmp
  --append-prompt "$APPEND_PROMPT"
)

show_help() {
  cat <<HELP
$SCRIPT_NAME $VERSION - Focussed wrapper for 'bcs check ...'

Usage: $SCRIPT_NAME ['bcs check' options] BASHFILE

Run 'bcs check -h' for all options

Pre-Set 'bcs check' Options:

$(printf '    %s\n' "${OPTS[*]}")
HELP
}

declare -- TARGET_SCRIPT=''

while (($#)); do
  case $1 in
    -V|--version)
      echo "$SCRIPT_NAME $VERSION"
      exit 0
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    -f|--format|--codes|--sections|--tier|--claude-cmd|--append-prompt|--allowed-tools|--add-dir|--severity)
      OPTS+=("$1" "$2")
      shift
      ;;
    -*)
      OPTS+=("$1")
      ;;
    *)
      [[ -z "$TARGET_SCRIPT" ]] || die 1 "Target script file already specified ${TARGET_SCRIPT@Q}"
      TARGET_SCRIPT=$1
      [[ -f "$TARGET_SCRIPT" ]] || die 3 "File ${TARGET_SCRIPT@Q} not found"
      OPTS+=("$TARGET_SCRIPT" --add-dir "$(dirname -- "$(realpath -- "$TARGET_SCRIPT")")")
      ;;
  esac
  shift ||:
done

exec bcs check "${OPTS[@]}"
#fin
