#!/bin/bash
#shellcheck disable=SC2034,SC2155
# Launch claude.x with BCS compliance checking agent
set -euo pipefail
shopt -s inherit_errexit shift_verbose extglob nullglob

declare -r VERSION='1.0.1'

# Determine BCS directory dynamically based on this script's location
# When installed: /usr/local/share/yatti/bash-coding-standard/lib/agents/bcs-compliance
# When in repo:   /ai/scripts/Okusi/bash-coding-standard/lib/agents/bcs-compliance
declare -- SCRIPT_PATH
SCRIPT_PATH=$(realpath -- "${BASH_SOURCE[0]}")
declare -r SCRIPT_DIR=${SCRIPT_PATH%/*}                          # lib/agents/
declare -r LIB_DIR=${SCRIPT_DIR%/*}                              # lib/
declare -r BCS_DIR=${LIB_DIR%/*}                                 # bash-coding-standard/
declare -r BCS_NAME=BASH-CODING-STANDARD.summary.md
declare -r BCS_PATH="$BCS_DIR"/data/"$BCS_NAME"

# Find shlock (vendored → development → system PATH)
declare -- SHLOCK_CMD=''
declare -a shlock_paths=(
  "$BCS_DIR/lib/shlock/shlock"                               # Vendored (same BCS installation)
  /ai/scripts/lib/shlock/shlock                              # Development environment
  "$(command -v shlock 2>/dev/null || echo '')"              # System PATH
)

for path in "${shlock_paths[@]}"; do
  if [[ -n "$path" && -x "$path" ]]; then
    SHLOCK_CMD=$path
    break
  fi
done

if [[ -z "$SHLOCK_CMD" ]]; then
  >&2 echo 'bcs-compliance: error: shlock not found'
  >&2 echo 'Expected locations:'
  >&2 echo "  - $BCS_DIR/lib/shlock/shlock (bundled)"
  >&2 echo '  - /ai/scripts/lib/shlock/shlock (development)'
  >&2 echo '  - shlock in PATH (system)'
  exit 1
fi
readonly -- SHLOCK_CMD

"$SHLOCK_CMD" -- claude.x -T leet \
    "$@" \
    --add-dir "$BCS_DIR" \
    --append-system-prompt "Read, examine, understand, and internalise, the summarized Bash Coding Standard (BCS, '$BCS_PATH'). You are a Bash coding quality expert with a complete knowledge of this standard. Your task is to analyse code submitted by the user for its compliance with the standard, and to make a comprehensive report. Make sure you have read, examined, understood, and internalized, the summarized Bash Coding Standard (BCS, '$BCS_PATH') before responding to user queries."

#fin
