#!/usr/bin/env bash
# Quick commit helper: clean, commit, and push changes to git
set -euo pipefail
shopt -s inherit_errexit shift_verbose

# Script metadata
SCRIPT_PATH=$(readlink -en -- "$0")
SCRIPT_DIR=${SCRIPT_PATH%/*}
SCRIPT_NAME=./bash-coding-standard
# Configuration - adjust for your environment
REPO_USER=$USER
REPO_GROUP=$USER
declare -r SCRIPT_PATH SCRIPT_DIR SCRIPT_NAME REPO_USER REPO_GROUP

# Cleanup handler
cleanup() {
  local -i exitcode=${1:-0}
  exit "$exitcode"
}
trap 'cleanup $?' SIGINT SIGTERM EXIT

# Change to script directory
cd "$SCRIPT_DIR"

# Fix ownership 
sudo chown "$REPO_USER:$REPO_GROUP" "$SCRIPT_DIR" -R

# Clean repository 
cln -Nq

# get version
declare -- version
version=$("$SCRIPT_NAME" --version | cut -d' ' -f2)

# Stage and commit changes
git add .
git commit -m "${1:-update $version}"

# Push to remote if configured
if git remote -v | grep -q origin; then
  git push
else
  echo 'Warning: No git remote configured. Skipping push.'
  echo 'To push manually, set up remote with: git remote add origin <url>'
  echo 'Then run: git push -u origin main'
fi

#fin
